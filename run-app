#!/bin/bash

# Make sure stop-app is executable (harmless if already is)
chmod +x ./stop-app 2>/dev/null

# Download the model
chmod +x ./app/download-model.sh && ./app/download-model.sh

# Start docker-compose in the background
docker-compose up --build &

# Get PID so we can track if it crashes
DC_PID=$!

# Wait until FastAPI is reachable
echo "⏳ Waiting for http://localhost:8000 to be available..."

until curl -s http://localhost:8000 > /dev/null; do
  sleep 1

  # Exit early if docker-compose crashed
  if ! ps -p $DC_PID > /dev/null; then
    echo "❌ Docker failed to start. Check logs above."
    exit 1
  fi
done

# When FastAPI is ready, open the browser
echo "✅ FastAPI is running. Launching browser..."

if command -v open > /dev/null; then
  open http://localhost:8000         # macOS
elif command -v xdg-open > /dev/null; then
  xdg-open http://localhost:8000     # Linux
elif command -v start > /dev/null; then
  start http://localhost:8000        # Windows Git Bash
else
  echo "ℹ️ Please open your browser to http://localhost:8000"
fi